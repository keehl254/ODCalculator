<!DOCTYPE html>
<html>
    <head>
        <script src="jquery.min.js"></script>
        <script src="script.js"></script>
        <script>
            var graphColors = [
                ["#D70206","#F05B4F"],
                ["#FFFF00","#FFC000"],
                ["#5CDC6F","#D5F6DB"]
            ]

            function fixPercent(percent) {
                return Math.round((percent + Number.EPSILON) * 10000) / 100
            }

            function findRequiredTilGoal(transactions, loyaltyTransactions) {
                var percent = loyaltyTransactions/transactions;
                if(percent > 0.6)
                    return 0;
                var count = 0;
                while(percent < 0.6) {
                    transactions++;
                    loyaltyTransactions++;
                    count++;
                    percent = loyaltyTransactions/transactions;
                }
                return count;
            }

            function scoreAssociate(totalTransactions, associateRow) {
                var points = 0;
                points += associateRow[8] * 0.2;
                points += associateRow[7] * 2;

/*                var penetrationImpact = (associateRow[1]*100) / totalTransactions;
                points += 100-(penetrationImpact * associateRow[3]);


                if(associateRow[4] > 0 && associateRow[3] == 100)
                    points-=5;*/

                associateRow[9] = 100-points;
                console.log(associateRow[0]+": "+associateRow[9])
            }

            function formatTable(data,totals) {
                $("#excel_table").html("<table cellpadding='0' cellspacing='0' border='0' bgcolor='white' style='border-collapse: collapse;width:600px'><tbody></tbody></table>");

                if(totals == null)
                    totals = ["Totals",0,0,0,0,0,0,0,0];

                var table = $("#excel_table");
                var tbody = $(table).find("table tbody");

                var headerRow = $("<tr />");
                var cols = [["Cashier",4,-1],["Transactions",4,-1],["REW Transactions",1,-1],["Penetration",1,55,60], ["Signups",1,-1], ["Signup Rate",1,5,10], ["Needed for 5%",1,-1], ["Needed for 10%",1,-1],["Needed for goal",1,-1]];
                for(var col of cols)
                    headerRow.append("<td colspan='"+col[1]+"' class='excel_td excel_header'><p><span>"+col[0]+"</span></p></td><td class='excel_td excel_header'></td>");
                headerRow.children().last().remove();
                tbody.prepend(headerRow);

                var blankRow = ["","","","","","","","",""];
                var totalIndex = Math.max(data.length,20);
                for(var i=0;i<=totalIndex;i++) {
                    var row,rowClass;
                    if(i == totalIndex)
                        row = totals;
                    else {
                        if(i < data.length)
                            row = data[i];
                        else
                            row = blankRow;
                        if(i % 2 == 1)
                            rowClass = "excel_td excel_mod";
                        else
                            rowClass = "excel_td";
                    }
                    var rowTD = $("<tr valign='top' />");
                    for(var col=0;col<9;col++) {
                        var style ="";
                        var backgroundColor;
                        if(cols[col][2] != -1 && i < data.length) {
                            if(row[col] < cols[col][2])
                                backgroundColor = 0;
                            else if(row[col] < cols[col][3])
                                backgroundColor = 1;
                            else
                                backgroundColor = 2;
                            style = "background-color: "+graphColors[backgroundColor][0]+";";
                        }
                        rowTD.append("<td colspan='"+cols[col][1]+"' class='"+rowClass+"' style='"+style+"'><p><span>"+row[col]+"</span></p></td><td><div style='width: 5px; height: 20px;'></div></td>");
                    }
                    rowTD.children().last().remove();
                    if(i == totalIndex)
                        rowTD.children().addClass("excel_header");
                    else if(i >= data.length)
                        rowTD.children().addClass("excel_blank");
                    tbody.append(rowTD);
                }

            }
            
        </script>
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" type="text/css" media="screen" href="nonPrintStyle.css" />
        <link rel="stlesheet" type="text/css" media="print" href="printStyle.css" />
    </head>
    <body>
        <input type="button" class="load_button" value="Load Today" id="load_today" \>
        <input type="button" class="load_button" value="Load WTD" id="load_wtd" \>
        <div id="ribbon" style="background-color: #B5120F;width:100%;height:50px;margin-top:50px;">
            <center><h1 style="color:#FFFFFF;line-height:50px;">Loyalty Rewards Calculator</h1></center>
        </div>
        <div id="wrapper">
            <div style="float:left;">
                <div id="excel_table" contenteditable = true></div>
            </div>
            <div>
                <div class="pie-charts">
                    <div class="pieID--penetration pie-chart--wrapper">
                      <h2>Penetration</h2>
                      <div class="pie-chart">
                        <div class="pie-chart__pie"></div>
                        <h3 class="pie-chart-percent" id="penetration_percent">100%</h3>
                      </div>
                    </div>

                    <div class="pieID--signup-rate pie-chart--wrapper">
                      <h2>New Signup Rate</h2>
                      <div class="pie-chart">
                        <div class="pie-chart__pie"></div>
                        <h3 class="pie-chart-percent" id="signup-rate-percent">100%</h3>
                      </div>
                    </div>
                </div>
            </div>
        </div>
        <script>

            formatTable([]);
            var textbox = document.getElementById("excel_table");

            function readData(table) {
                var tbody = $(table).find("table tbody");

                var data = [];

                tbody.children().each(function (index) {
                    var associateRow = [];
                    $(this).children().each(function(i) {
                        if((i % 2) == 0)
                            associateRow[i/2] = parseInt($(this,"p").text());
                    });

                    var transactionCountWOSignups = (associateRow[1]-associateRow[2]+associateRow[4]);

                    associateRow[5] = fixPercent(associateRow[4] / transactionCountWOSignups); // New Signup Rate
                    associateRow[6] = Math.ceil(fixPercent(Math.max((transactionCountWOSignups*0.05) - associateRow[4],0))/100); // Percentage of signups needed for 5%
                    associateRow[7] = Math.ceil(fixPercent(Math.max((transactionCountWOSignups*0.1) - associateRow[4],0))/100); // Percentage of signups needed for 10%
                    associateRow[8] = findRequiredTilGoal(associateRow[1],associateRow[2]);


                    if(isNaN(associateRow[5]))
                        associateRow[5] = "-";

                    if(!isNaN(associateRow[0]) && associateRow[0] != 1111)
                        data[data.length] = associateRow;
                    else
                        $(this).remove();
                });

                var totalTransactions = 0;
                var loyaltyTransactions = 0;
                var signupTransactions = 0;

                for(i=0;i<data.length;i++) {
                    totalTransactions += data[i][1];
                    loyaltyTransactions += data[i][2];
                    signupTransactions += data[i][4];
                }

                for(i=0;i<data.length;i++)
                    scoreAssociate(totalTransactions, data[i]);

                var transactionCountWOSignups = (totalTransactions-loyaltyTransactions+signupTransactions);

                var storePenetration = fixPercent(loyaltyTransactions/totalTransactions);
                var storeSignupRate = fixPercent(signupTransactions / transactionCountWOSignups);
                var storeNeededFive = Math.ceil(fixPercent(Math.max((transactionCountWOSignups*0.05) - signupTransactions,0))/100);
                var storeNeededTen = Math.ceil(fixPercent(Math.max((transactionCountWOSignups*0.1) - signupTransactions,0))/100);
                var transactionsForGoal = findRequiredTilGoal(totalTransactions, loyaltyTransactions);

                var totals = ["Totals",totalTransactions,loyaltyTransactions, storePenetration, signupTransactions, storeSignupRate,storeNeededFive,storeNeededTen, transactionsForGoal];

                var graphColor;
                if(storePenetration < 55)
                    graphColor = 0;
                else if(storePenetration < 60)
                    graphColor = 1;
                else
                    graphColor = 2;
                $("#penetration_percent").text(storePenetration+"%");
                createPercentagePie(storePenetration,'.pieID--penetration',graphColors[graphColor][0], graphColors[graphColor][1] );

                if(storeSignupRate < 5)
                    graphColor = 0;
                else if(storeSignupRate < 10)
                    graphColor = 1;
                else
                    graphColor = 2;
                $("#signup-rate-percent").text(storeSignupRate+"%");
                createPercentagePie(storeSignupRate,'.pieID--signup-rate',graphColors[graphColor][0], graphColors[graphColor][1] );

                data.sort(function(associateOne, associateTwo) {
                    return associateTwo[9]-associateOne[9];
                });

                formatTable(data,totals);
            }
          
            textbox.onpaste = function(event) {
                $("#excel_table").html("");
                setTimeout(function() {
                    $("#excel_table").blur();
                    var data = $("#excel_table");
                    readData(data);
                },1)
            };

            textbox.onclick = function(event) {
                formatTable([]);
            }

            $("#load_today").click(function() {
                var date = new Date().toISOString().split("T")[0];
                var startOfDay = new Date(date).getTime();
                var endOfDay = startOfDay + (86400 * 1000);
                window.open("ods06626w10:7001/odpposservlet/ODOpenReport?report=odr&start_date="+startOfDay+"&end_date="+endOfDay+"&precision=2");

                $.get( "ODOpenReport.htm", function( data ) {
                    console.log(data);     
                });

            });

            createPieCharts();
        </script>
    </body>
</html>
